<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kurir - QR Auto Scan Stok Opname (Fixed)</title>
<!-- pinned stable jsQR version -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#0ea5a4; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    --text:#0f1724;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial, sans-serif;background:linear-gradient(180deg,#f8fafc 0,#f1f5f9 100%);color:var(--text)}
  .wrap{max-width:1100px;margin:20px auto;padding:18px;}
  header{text-align:center;margin-bottom:8px;}
  h1{margin:6px 0;font-size:28px}
  .layout{display:grid;grid-template-columns:420px 1fr;gap:18px;align-items:start;}
  .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}
  #preview{width:100%;height:280px;background:#000;border-radius:10px;object-fit:cover}
  .controls{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .btn.primary{background:#0284c7;color:white}
  .btn.ghost{background:transparent;border:1px solid #e6eef6;color:#0f1724}
  .status-big{height:120px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700}
  .status-ok{background:linear-gradient(90deg,#ecfeff,#bbf7d0);color:#064e3b}
  .status-dup{background:linear-gradient(90deg,#fff7ed,#fff3bf);color:#92400e}
  .status-err{background:linear-gradient(90deg,#fff1f2,#ffd6d6);color:#7f1d1d}
  .log{max-height:420px;overflow:auto;margin-top:12px;padding:8px;border-radius:8px;background:#f8fafc}
  .log-item{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px}
  .small{font-size:13px;color:#475569}
  .config{font-size:13px;margin-top:10px}
  footer{text-align:center;margin-top:18px;color:#475569;font-size:13px}
  .muted{color:#6b7280;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>QR SCAN EAGLE EYE — PT.  BJN</h1><div class="small">MARK 7</div></header>

  <div class="layout">
    <!-- Left: camera + controls -->
    <div class="card">
      <video id="preview" autoplay playsinline></video>
      <div class="controls">
        <button id="btnStart" class="btn primary">Start Scan</button>
        <button id="btnStop" class="btn ghost">Stop Scan</button>
        <button id="btnManual" class="btn">Manual Input</button>
        <button id="btnQueue" class="btn">Queue</button>
        <label style="display:flex;align-items:center;gap:6px" class="muted"><input type="checkbox" id="chkUltra"> Ultra Speed</label>
      </div>

      <div id="statusBig" class="status-big status-err" style="margin-top:12px">Memulai...</div>

      <div style="margin-top:12px" class="small">
        <div>Script URL: <span id="scriptUrlShow" style="font-weight:700;word-break:break-all"></span></div>
        <div class="config">Debounce: <span id="debounceVal">1500</span> ms • Offline storage</div>
      </div>
    </div>

    <!-- Right: log, last scan -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Last Scan</strong><div id="lastScanText" class="small">Belum ada</div></div>
          <div><strong>Status</strong></div>
        </div>

        <div id="statusMini" style="margin-top:12px" class="status-big status-ok">Siap</div>

        <div class="log" id="logBox" aria-live="polite" style="margin-top:12px">
          <!-- log items -->
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Actions</strong>
        <div style="margin-top:8px" class="small">Beep & vibrate on success</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnExport" class="btn">Export Log</button>
          <button id="btnClear" class="btn">Clear Local Queue</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Built for speed — Scan to sync with Google Sheet</footer>
</div>

<script>
/* ===== CONFIG ===== */
const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx93FgQkFv-GDTkJVsh0Bpe1KUrbRX28y29rNEqY-7IsJyYUZz0Sg4DD_NWqzMwaipE/exec';
const SCRIPT_URL = localStorage.getItem('SCRIPT_URL') || DEFAULT_SCRIPT_URL;
const DEBOUNCE_DEFAULT = 1500;
let DEBOUNCE = Number(localStorage.getItem('DEBOUNCE')) || DEBOUNCE_DEFAULT;

/* ===== UI helpers ===== */
const preview = document.getElementById('preview');
const statusBig = document.getElementById('statusBig');
const statusMini = document.getElementById('statusMini');
const logBox = document.getElementById('logBox');
const lastScanText = document.getElementById('lastScanText');
const debounceValEl = document.getElementById('debounceVal');
const scriptUrlShow = document.getElementById('scriptUrlShow');
const chkUltra = document.getElementById('chkUltra');

scriptUrlShow.innerText = SCRIPT_URL;
debounceValEl.innerText = DEBOUNCE;

function pushLog(text){
  const d = new Date().toLocaleString();
  const el = document.createElement('div'); el.className='log-item'; el.innerText = d + ' — ' + text;
  logBox.prepend(el);
}

/* ===== Offline queue (localStorage) ===== */
const QUEUE_KEY = 'SO_Q_QUEUE_v2';
function readQueue(){ try { return JSON.parse(localStorage.getItem(QUEUE_KEY))||[] } catch(e){return[]} }
function writeQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)) }
function enqueue(item){ const q = readQueue(); q.push(item); writeQueue(q); pushLog('Queued (local) ' + item.qr); }
function dequeue(){ const q = readQueue(); const item = q.shift(); writeQueue(q); return item; }

/* ===== Camera + scan using jsQR ===== */
let stream=null;
let scanningLock=false; // prevents double-processing while handling
let lastTime=0;
let canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');

async function startCamera(){
  if(stream) { pushLog('Camera already running'); return; }
  try{
    statusBig.className='status-big status-err';
    statusBig.innerText='Meminta izin kamera...';
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    preview.srcObject = stream;
    await preview.play();
    statusBig.className='status-big status-ok';
    statusBig.innerText='Siap scan';
    pushLog('Camera started');
    startLoop();
  }catch(e){ console.error(e); statusBig.className='status-big status-err'; statusBig.innerText='Gagal buka kamera'; pushLog('Camera error: '+(e.message||e)); stream=null; }
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
    pushLog('Camera stopped');
  }
  statusBig.className='status-big status-err';
  statusBig.innerText='Kamera berhenti';
}

function startLoop(){
  if(!stream) return;
  const video = preview;
  const tick = ()=>{
    if(!stream) return;
    try{
      if(video.readyState >= 2){
        // ensure canvas sized
        const w = video.videoWidth || 640; const h = video.videoHeight || 480;
        if(w && h){
          canvas.width = w; canvas.height = h;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const img = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = jsQR(img.data, canvas.width, canvas.height, { inversionAttempts: 'attemptBoth' });
          if(code){
            const now = Date.now();
            const ultra = chkUltra.checked;
            const debounce = ultra ? 100 : DEBOUNCE; // ultra reduces debounce
            if(now - lastTime >= debounce && !scanningLock){
              lastTime = now;
              scanningLock = true; // lock while handling
              handleDecoded(code.data).finally(()=>{ scanningLock=false; });
            }
          }
        }
      }
    }catch(er){ console.warn('scan loop err',er); }
    requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

/* ===== beep using WebAudio (more reliable than data-uri) ===== */
function beepOk(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.value = 880;
    g.gain.value = 0.05; // gentle
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){ console.warn('beep fail',e); }
}
function vibrate(){ if(navigator.vibrate) navigator.vibrate([80]); }

/* ===== handle decoded text ===== */
async function handleDecoded(text){
  lastScanText.innerText = text;
  pushLog('Scanned: '+text);

  let payload = null;
  try { const parsed = JSON.parse(text); payload = { qr: JSON.stringify(parsed) }; } catch(e) { payload = { qr: String(text) }; }

  // Try send immediately, if offline enqueue
  try {
    const res = await postToServer(payload);
    handleResponse(res, payload);
  } catch (err) {
    enqueue({qr: payload.qr, ts: new Date().toISOString()});
    statusBig.className='status-big status-err';
    statusBig.innerText = 'Offline — queued';
    pushLog('Network error -> queued');
  }
}

/* ===== POST helper ===== */
async function postToServer(body){
  if(!SCRIPT_URL) throw new Error('NO_URL');
  // short timeout helper
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 8000);
  try{
    const r = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body),
      signal: controller.signal
    });
    clearTimeout(timeout);
    const txt = await r.text();
    return txt;
  }catch(e){ clearTimeout(timeout); throw e; }
}

/* ===== handle server response ===== */
function handleResponse(text, payload){
  if(!text) text='ERR: empty';
  if(typeof text === 'object') text = JSON.stringify(text);
  if(text.indexOf('OK')===0 || text.toUpperCase().indexOf('OK')===0){
    statusBig.className='status-big status-ok';
    statusBig.innerText = '✔ OK';
    statusMini.className='status-big status-ok';
    statusMini.innerText = 'OK';
    pushLog('Saved remote: '+payload.qr);
    beepOk(); vibrate();
  } else if(text.toUpperCase().indexOf('DUPLIKAT')===0 || text.toUpperCase().indexOf('DUPLICATE')===0){
    statusBig.className='status-big status-dup';
    statusBig.innerText = '⚠ DUPLIKAT';
    statusMini.className='status-big status-dup';
    statusMini.innerText = 'DUPLIKAT';
    pushLog('Duplicate (server): '+payload.qr);
  } else {
    statusBig.className='status-big status-err';
    statusBig.innerText = '❌ ERROR';
    pushLog('Server error: '+text);
  }
}

/* ===== try flush queue when online ===== */
let flushing=false;
async function flushQueue(){
  if(flushing) return; // avoid concurrent flushes
  const q = readQueue();
  if(q.length===0) return;
  flushing = true;
  pushLog('Flushing queue ('+q.length+')...');
  for(let i=0;i<q.length;i++){
    try{
      const item = q[i];
      const res = await postToServer({qr: item.qr});
      pushLog('Flushed: '+item.qr+' -> '+(res||'NO_RESP'));
      if(res && (res.indexOf('OK')===0 || res.toUpperCase().indexOf('OK')===0)){
        dequeue(); i--; // removed first element
      } else if(res && (res.toUpperCase().indexOf('DUPLIKAT')===0 || res.toUpperCase().indexOf('DUPLICATE')===0)){
        dequeue(); i--;
      } else {
        // stop flushing on server error
        break;
      }
    }catch(e){
      pushLog('Flush error: '+(e.message||e));
      break;
    }
  }
  flushing=false;
}

/* ===== UI Buttons ===== */
document.getElementById('btnStart').addEventListener('click',()=>{ startCamera(); });
document.getElementById('btnStop').addEventListener('click',()=>{ stopCamera(); });
document.getElementById('btnManual').addEventListener('click',async ()=>{
  const q = prompt('Masukkan payload QR (JSON atau pipe |):');
  if(!q) return;
  await handleDecoded(q);
});
document.getElementById('btnQueue').addEventListener('click',()=>{ const q = readQueue(); alert('Queued: '+q.length+' items'); });
document.getElementById('btnExport').addEventListener('click',()=>{
  const q = readQueue();
  const blob = new Blob([JSON.stringify(q, null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='queue.json'; a.click();
});
document.getElementById('btnClear').addEventListener('click',()=>{ if(confirm('Clear local queue?')){ writeQueue([]); pushLog('Queue cleared'); } });

/* ===== auto start & online listener ===== */
window.addEventListener('load', ()=>{ 
  // set UI
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    statusBig.className='status-big status-err';
    statusBig.innerText='Browser tidak mendukung kamera';
    pushLog('No camera support');
    return;
  }
  startCamera();
  // try flush queue frequently but not too often
  setInterval(()=>{ if(navigator.onLine) flushQueue(); },3000);
});
window.addEventListener('online', ()=>{ pushLog('Back online'); flushQueue(); });
window.addEventListener('offline', ()=>{ pushLog('Offline'); });

</script>
</body>
</html>
